<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="lib/bootstrap_v4.min.css">

    <title>Rückgabe</title>
	
	<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="lib/jquery_v3.2.1.min.js"></script>
    <script src="lib/popper_v1.12.9.min.js"></script>
    <script src="lib/bootstrap_v4.min.js" ></script>
	<script src="lib/elaspix_lookupDropdown.js" ></script>
	<script src="lib/elaspix_inputtext.js" ></script>
	<script src="lib/elaspix_eventclock.js" ></script>
	<script src="lib/elaspix_dropdown_desktop.js" ></script>
	<script src="lib/elaspix_rueckgabe.js" ></script>	
	<script src="lib/jquery.md5.js" ></script>
	
  </head>
  <body>
    <div class="container">
		<div class="jumbotron mt-4">
		  <h1 class="display-4">Rückgabe</h1>
		  <p class="lead">Fahrräder können zurückgegeben werden.</p>		  
		</div>
		<div id="parent"></div>
	</div>
	
	<script>
		var rueckgabe;
		$(function(){
			rueckgabe=createRueckgabe({
					"parent":$("#parent"),
					"onRueckgabeBike":onRueckgabeBike
		})
		//rueckgabe.setStations({"Station1Key":"Name Station 1","Station2Key":"Name Station 2"});
		loadList(rueckgabe)
		});

		function loadList(listName) {
            list = [];
            $.getJSON("https://webtechlecture.appspot.com/cloudstore/listkeys?owner=19_stationen", function(data) {
            for (let index = 0; index < data.length; index++) {
            //list.push(data[index].key)
			list[data[index].key] = data[index].key
            }
                listName.setStations(list);
            });     
        };
		
		function onRueckgabeBike(aEmail,aPassword,aStation, aBikeID)
		{
			console.log("Kunde",aEmail,"gibt Fahrrad",aBikeID,"zurück an Station",aStation);
			verify(aEmail,aPassword, aStation, aBikeID)
			
		}

		function verify(aEmail, aPassword, aStation, aBikeID){
 			$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_kunden&key="+encodeURIComponent(aEmail), function(data){
                if (aEmail == data.email) {
                    if ($.md5(aPassword) == data.password) {
						returnBike(aEmail, aStation, aBikeID)
                } else {
                    console.log("wrong password")
                }
            }else {
                console.log("no such account")
                }
            })
        }    
		
		function returnBike(aEmail, aStation, aBikeID){
			$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_kunden&key="+encodeURIComponent(aEmail), function(data){
				console.log(data)
				for (let index = 0; index < data.bikes.length; index++) {
					if (data.bikes[index]==aBikeID) {
						console.log(data.bikes)
						data.bikes.splice(index,1)
						$.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=19_kunden&key="+encodeURIComponent(aEmail)+"&jsonstring="+encodeURIComponent(JSON.stringify(data))+"&token=FtyelhCI49sIMP0VSZiuazbD1ow_", function(data){
						});
						$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_stationen&key="+encodeURIComponent(aStation), function(data){
							data.bikes.push(aBikeID)
							$.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=19_stationen&key="+encodeURIComponent(aStation)+"&jsonstring="+encodeURIComponent(JSON.stringify(data))+"&token=R84O2SrCQuX8BLpbCT4sGld4xZI_", function(data){
								console.log("returned Bike")
							})
						})
					};
				}
			})
		}	
	</script>
	
  </body>
</html>