<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="lib/bootstrap_v4.min.css">

    <title>Ausleihe</title>
	
	<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="lib/jquery_v3.2.1.min.js"></script>
    <script src="lib/popper_v1.12.9.min.js"></script>
    <script src="lib/bootstrap_v4.min.js" ></script>
	<script src="lib/elaspix_lookupDropdown.js" ></script>
	<script src="lib/elaspix_inputtext.js" ></script>
	<script src="lib/elaspix_eventclock.js" ></script>
	<script src="lib/elaspix_dropdown_desktop.js" ></script>
	<script src="lib/elaspix_ausleihe.js" ></script>	
	<script src="lib/jquery.md5.js" ></script>
	
  </head>
  <body>
    <div class="container">
		<div class="jumbotron mt-4">
		  <h1 class="display-4">Ausleihe</h1>
		  <p class="lead">Fahrräder können ausgeliehen werden.</p>		  
		</div>
		<div id="parent"></div>
	</div>
	
	<script>
		var ausleihe;
		$(function(){
			ausleihe=createAusleihe({
					"parent":$("#parent"),
					"onAusleiheBike":onAusleiheBike
		})
		//ausleihe.setStations({"Station1Key":"Name Station 1","Station2Key":"Name Station 2"});
		loadList(ausleihe)
		});
		
		function loadList(listName) {
            list = [];
            $.getJSON("https://webtechlecture.appspot.com/cloudstore/listkeys?owner=19_stationen", function(data) {
            for (let index = 0; index < data.length; index++) {
            //list.push(data[index].key)
			list[data[index].key] = data[index].key
            }
                listName.setStations(list);
            });     
        };

		function onAusleiheBike(aEmail,aPassword,aStation, aAnzahl)
		{
			console.log("Kunde",aEmail,"leiht Fahrrad aus an Station",aStation,"mit Anzahl",aAnzahl);
			verify(aEmail, aPassword, aStation, aAnzahl)
		}

		function verify(aEmail, aPassword, aStation, aAnzahl){
 			$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_kunden&key="+encodeURIComponent(aEmail), function(data){
                if (aEmail == data.email) {
                    if ($.md5(aPassword) == data.password) {
						rentBike(aEmail,aStation,aAnzahl)
                } else {
                    console.log("wrong password")
                }
            }else {
                console.log("no such account")
                }
            })
        }      

		function rentBike(aEmail, aStation, aAnzahl){
			$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_stationen&key="+aStation, function(data) {
			if (data.bikes.length < aAnzahl) {
				console.log("Station doesn't have "+aAnzahl+" bikes")
			}else {
				var bike = []
				for (let index = 0; index < aAnzahl; index++) {
					bike.push(data.bikes.pop());
					console.log(data.bikes)
					console.log(bike)
				}
				$.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=19_stationen&jsonstring="+encodeURIComponent(JSON.stringify(data))+"&key="+aStation+"&token=R84O2SrCQuX8BLpbCT4sGld4xZI_", function(data) {
							console.log("changed Station: ", data)
					});	
				
				$.getJSON("https://webtechlecture.appspot.com/cloudstore/get?owner=19_kunden&key="+aEmail, function(kundenData) {
						for (let index = 0; index < bike.length; index++) {
							kundenData.bikes.push(bike[index])
						};

						$.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=19_kunden&key="+aEmail+"&jsonstring="+encodeURIComponent(JSON.stringify(kundenData))+"&token=FtyelhCI49sIMP0VSZiuazbD1ow_", function(response) {
						console.log("added bike to customer: ", response)
						});
					})
			}});	
		}

		
	</script>
	
  </body>
</html>